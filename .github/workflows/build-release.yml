name: Build Node.js Android ARM64

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node.js version (e.g. 24.13.0)'
        required: true
        default: '24.13.0'
      ndk_version:
        description: 'Android NDK version (e.g. r27c)'
        required: true
        default: 'r27c'
      android_api:
        description: 'Android min API level'
        required: true
        default: '24'
      termux_ref:
        description: 'Termux packages branch/tag/SHA for patches'
        required: true
        default: 'master'
      create_release:
        description: 'Create a GitHub Release after build'
        type: boolean
        default: true

  # Also trigger on version tags: v24.13.0, etc.
  push:
    tags:
      - 'v*.*.*'

env:
  # Defaults used when triggered by tag push (not workflow_dispatch)
  DEFAULT_NODE_VERSION: '24.13.0'
  DEFAULT_NDK_VERSION: 'r27c'
  DEFAULT_ANDROID_API: '24'
  DEFAULT_TERMUX_REF: 'master'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/node-android-arm64-builder

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1: Resolve inputs (works for both manual dispatch and tag push)
  # ──────────────────────────────────────────────────────────────────────────
  resolve-inputs:
    name: Resolve build inputs
    runs-on: ubuntu-latest
    outputs:
      node_version: ${{ steps.resolve.outputs.node_version }}
      ndk_version:  ${{ steps.resolve.outputs.ndk_version }}
      android_api:  ${{ steps.resolve.outputs.android_api }}
      termux_ref:   ${{ steps.resolve.outputs.termux_ref }}
      create_release: ${{ steps.resolve.outputs.create_release }}
      release_tag:  ${{ steps.resolve.outputs.release_tag }}

    steps:
      - name: Resolve inputs
        id: resolve
        run: |
          # When triggered by tag, parse version from the tag (strips leading 'v')
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
            NODE_VERSION="${TAG#v}"
            NDK_VERSION="${{ env.DEFAULT_NDK_VERSION }}"
            ANDROID_API="${{ env.DEFAULT_ANDROID_API }}"
            TERMUX_REF="${{ env.DEFAULT_TERMUX_REF }}"
            CREATE_RELEASE="true"
          else
            NODE_VERSION="${{ github.event.inputs.node_version }}"
            NDK_VERSION="${{ github.event.inputs.ndk_version }}"
            ANDROID_API="${{ github.event.inputs.android_api }}"
            TERMUX_REF="${{ github.event.inputs.termux_ref }}"
            CREATE_RELEASE="${{ github.event.inputs.create_release }}"
          fi

          RELEASE_TAG="node-v${NODE_VERSION}-android-arm64"

          echo "node_version=${NODE_VERSION}"   >> $GITHUB_OUTPUT
          echo "ndk_version=${NDK_VERSION}"     >> $GITHUB_OUTPUT
          echo "android_api=${ANDROID_API}"     >> $GITHUB_OUTPUT
          echo "termux_ref=${TERMUX_REF}"       >> $GITHUB_OUTPUT
          echo "create_release=${CREATE_RELEASE}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}"     >> $GITHUB_OUTPUT

          echo "### Resolved inputs" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | \`${NODE_VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| NDK | \`${NDK_VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Android API | \`${ANDROID_API}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Termux ref | \`${TERMUX_REF}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release tag | \`${RELEASE_TAG}\` |" >> $GITHUB_STEP_SUMMARY

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2: Build
  # ──────────────────────────────────────────────────────────────────────────
  build:
    name: Build libnode.so
    needs: resolve-inputs
    runs-on: ubuntu-latest

    # This build needs a lot of space — free up disk first
    env:
      NODE_VERSION: ${{ needs.resolve-inputs.outputs.node_version }}
      NDK_VERSION:  ${{ needs.resolve-inputs.outputs.ndk_version }}
      ANDROID_API:  ${{ needs.resolve-inputs.outputs.android_api }}
      TERMUX_REF:   ${{ needs.resolve-inputs.outputs.termux_ref }}

    steps:
      # ── Free up GitHub Actions disk space ──────────────────────────────
      # The runner only has ~14 GB free by default; the build needs ~20 GB.
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h /

          # Remove large pre-installed software we don't need
          sudo rm -rf \
            /usr/local/lib/android \
            /usr/share/dotnet \
            /opt/ghc \
            /usr/local/share/boost \
            "$AGENT_TOOLSDIRECTORY" \
            /usr/lib/jvm \
            /usr/share/swift \
            /usr/local/julia* \
            /opt/hostedtoolcache/CodeQL

          sudo apt-get clean
          docker image prune -af 2>/dev/null || true

          echo "After cleanup:"
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Docker layer cache (speeds up repeat builds significantly) ──────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Cache key includes Node + NDK versions so changing either invalidates
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-node${{ env.NODE_VERSION }}-ndk${{ env.NDK_VERSION }}-api${{ env.ANDROID_API }}-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            buildx-node${{ env.NODE_VERSION }}-ndk${{ env.NDK_VERSION }}-
            buildx-node${{ env.NODE_VERSION }}-
            buildx-

      # ── Build the Docker image ──────────────────────────────────────────
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: artifacts
          push: false
          load: true
          tags: node-android-arm64-builder:local
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            NDK_VERSION=${{ env.NDK_VERSION }}
            ANDROID_API=${{ env.ANDROID_API }}
            TERMUX_REF=${{ env.TERMUX_REF }}
            JOBS=3
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to:   type=local,dest=/tmp/.buildx-cache-new,mode=max

      # Prevent cache from growing unbounded
      - name: Rotate build cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # ── Extract artifacts from the image ────────────────────────────────
      - name: Extract artifacts
        run: |
          mkdir -p ./output
          docker run --rm \
            -v "$(pwd)/output:/out" \
            node-android-arm64-builder:local \
            bash -c "cp -r /artifacts/. /out/ && chmod -R 755 /out"

          echo "### Build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find ./output -type f | sort | while read f; do
            SIZE=$(du -sh "$f" | cut -f1)
            echo "${SIZE}  ${f}"
          done >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # ── Verify it's actually an ARM64 shared lib ────────────────────────
      - name: Verify libnode.so
        run: |
          echo "=== file output ==="
          file ./output/lib/libnode.so

          echo "=== ELF header ==="
          readelf -h ./output/lib/libnode.so | grep -E "Class|Machine|Type|Entry"

          echo "=== Exported symbols (first 20) ==="
          nm -D ./output/lib/libnode.so 2>/dev/null | head -20 || \
          objdump -T ./output/lib/libnode.so 2>/dev/null | head -20 || \
          echo "(nm/objdump not available for cross arch)"

          echo "=== Size ==="
          du -sh ./output/lib/libnode.so

      # ── Package everything into release archives ─────────────────────────
      - name: Package artifacts
        run: |
          NODE_VER="${{ env.NODE_VERSION }}"
          ANDROID_API="${{ env.ANDROID_API }}"

          # Main archive: libnode.so + all headers
          tar -czf "libnode-v${NODE_VER}-android-arm64-api${ANDROID_API}.tar.gz" \
              -C ./output .

          # Separate archives for convenience
          tar -czf "libnode-v${NODE_VER}-android-arm64-api${ANDROID_API}-lib.tar.gz" \
              -C ./output/lib .

          tar -czf "libnode-v${NODE_VER}-android-arm64-api${ANDROID_API}-headers.tar.gz" \
              -C ./output/include .

          # Also package the JNI bridge source
          tar -czf "libnode-v${NODE_VER}-jni-bridge.tar.gz" \
              jni-bridge/

          ls -lh *.tar.gz

      # ── Upload as workflow artifact (available for 90 days) ─────────────
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: node-v${{ env.NODE_VERSION }}-android-arm64
          path: |
            libnode-*.tar.gz
          retention-days: 90
          compression-level: 0   # already gzipped

      # Pass archive filenames to the release job
      - name: Export archive paths
        id: archives
        run: |
          NODE_VER="${{ env.NODE_VERSION }}"
          ANDROID_API="${{ env.ANDROID_API }}"
          echo "full=libnode-v${NODE_VER}-android-arm64-api${ANDROID_API}.tar.gz"       >> $GITHUB_OUTPUT
          echo "lib=libnode-v${NODE_VER}-android-arm64-api${ANDROID_API}-lib.tar.gz"    >> $GITHUB_OUTPUT
          echo "headers=libnode-v${NODE_VER}-android-arm64-api${ANDROID_API}-headers.tar.gz" >> $GITHUB_OUTPUT
          echo "bridge=libnode-v${NODE_VER}-jni-bridge.tar.gz"                           >> $GITHUB_OUTPUT

    outputs:
      archive_full:    ${{ steps.archives.outputs.full }}
      archive_lib:     ${{ steps.archives.outputs.lib }}
      archive_headers: ${{ steps.archives.outputs.headers }}
      archive_bridge:  ${{ steps.archives.outputs.bridge }}

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3: Release
  # ──────────────────────────────────────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [resolve-inputs, build]
    runs-on: ubuntu-latest
    if: needs.resolve-inputs.outputs.create_release == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: node-v${{ needs.resolve-inputs.outputs.node_version }}-android-arm64
          path: ./release-assets

      - name: Generate checksums
        run: |
          cd ./release-assets
          sha256sum *.tar.gz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Generate release notes
        id: notes
        run: |
          NODE_VER="${{ needs.resolve-inputs.outputs.node_version }}"
          NDK_VER="${{ needs.resolve-inputs.outputs.ndk_version }}"
          ANDROID_API="${{ needs.resolve-inputs.outputs.android_api }}"
          TERMUX_REF="${{ needs.resolve-inputs.outputs.termux_ref }}"
          RELEASE_TAG="${{ needs.resolve-inputs.outputs.release_tag }}"

          cat > release_notes.md << EOF
          ## Node.js v${NODE_VER} — Android ARM64 (JNI)

          Pre-built \`libnode.so\` for embedding Node.js in Android apps via JNI.
          Built using [Termux patches](https://github.com/termux/termux-packages/tree/${TERMUX_REF}/packages/nodejs-lts).

          ### Build details
          | | |
          |---|---|
          | Node.js | \`${NODE_VER}\` |
          | Android NDK | \`${NDK_VER}\` |
          | Min API | \`${ANDROID_API}\` (Android 7.0+) |
          | Architecture | \`arm64-v8a\` (aarch64) |
          | Termux patches | [\`${TERMUX_REF}\`](https://github.com/termux/termux-packages/tree/${TERMUX_REF}/packages/nodejs-lts) |

          ### Downloads

          | File | Contents |
          |------|----------|
          | \`*-android-arm64-api${ANDROID_API}.tar.gz\` | Full bundle (libnode.so + all headers) |
          | \`*-android-arm64-api${ANDROID_API}-lib.tar.gz\` | \`libnode.so\` only |
          | \`*-android-arm64-api${ANDROID_API}-headers.tar.gz\` | Headers only (node/, uv/, v8/) |
          | \`*-jni-bridge.tar.gz\` | JNI C++ bridge + Kotlin wrapper |
          | \`SHA256SUMS.txt\` | Checksums |

          ### Quick integration

          \`\`\`bash
          # Extract libnode.so
          tar -xzf *-lib.tar.gz -C app/src/main/jniLibs/arm64-v8a/

          # Extract headers
          tar -xzf *-headers.tar.gz -C app/src/main/cpp/include/
          \`\`\`

          ### Build flags used
          \`\`\`
          --dest-os=android
          --dest-cpu=arm64
          --cross-compiling
          --shared
          --with-intl=small-icu
          --without-npm
          --without-inspector
          --openssl-no-asm
          --with-bundled-libuv
          \`\`\`

          > **Note**: \`libnode.so\` has libuv statically linked (required on Android — see [termux#462](https://github.com/termux/termux-packages/issues/462)).
          EOF

          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-inputs.outputs.release_tag }}
          name: "Node.js v${{ needs.resolve-inputs.outputs.node_version }} — Android ARM64"
          body_path: release_notes.md
          draft: false
          prerelease: false
          make_latest: true
          files: |
            ./release-assets/*.tar.gz
            ./release-assets/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "### ✅ Released!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.resolve-inputs.outputs.release_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.resolve-inputs.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
